name: Update Shaka-Packager Formula

on:
  schedule:
    - cron: '0 1 * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-formula:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Get Latest Version
      run: |
        latest_version=$(curl -s "https://api.github.com/repos/shaka-project/shaka-packager/releases/latest" | jq -r .tag_name | sed 's/^v//')
        echo "LATEST_VERSION=$latest_version" >> $GITHUB_ENV

    - name: Check current version
      run: |
        current_version=$(grep -m1 'version "[0-9]' Formula/shaka-packager.rb | cut -d '"' -f 2)
        if [ "$current_version" = "${{ env.LATEST_VERSION }}" ]; then
          echo "SKIP_UPDATE=true" >> $GITHUB_ENV
        else
          echo "SKIP_UPDATE=false" >> $GITHUB_ENV
        fi

    - name: Update Formula
      if: env.SKIP_UPDATE == 'false'
      run: |
        # Calculate SHA256s
        arm_url="https://github.com/shaka-project/shaka-packager/releases/download/v${{ env.LATEST_VERSION }}/packager-osx-arm64"
        intel_url="https://github.com/shaka-project/shaka-packager/releases/download/v${{ env.LATEST_VERSION }}/packager-osx-x64"
        
        sha_arm=$(curl -L -s "$arm_url" | sha256sum | awk '{ print $1 }')
        sha_intel=$(curl -L -s "$intel_url" | sha256sum | awk '{ print $1 }')

        # Update File
        sed -i "s/version \".*\"/version \"${{ env.LATEST_VERSION }}\"/" Formula/shaka-packager.rb
        
        # Replace SHA256 (Logique spécifique pour remplacer le bon hash selon l'ordre dans le fichier)
        # On assume que le premier sha256 trouvé est ARM (cf structure du fichier) et le second Intel si on lit ligne par ligne
        # Mais pour être sûr avec sed, on va utiliser le contexte de l'URL précédente si possible, 
        # ou simplement remplacer tout le bloc si la structure est fixe.
        
        sed -i "/packager-osx-arm64/{n;s/sha256 \".*\"/sha256 \"$sha_arm\"/;}" Formula/shaka-packager.rb
        sed -i "/packager-osx-x64/{n;s/sha256 \".*\"/sha256 \"$sha_intel\"/;}" Formula/shaka-packager.rb

        # Commit
        git config user.name "GitHub Actions"
        git config user.email "actions@github.com"
        git commit -am "Update shaka-packager Formula to ${{ env.LATEST_VERSION }}"
        git push
